#!/bin/bash

`msh src lib/init`

if [ $# -lt 1 ]; then
  echo "Usage: $(basename $0) SESSION [COMMAND]"
  exit 1
fi

if [ "$1" = "-l" ]; then
  tmux list-sessions -F "#{session_name}"
  ls -t1 "$ACTIVITIES_DIR"
  exit 0
fi

# replace space with dash for easier string handling
SESSION_NAME=${1// /-}
# replace dots with underscores to not break tmux pane names
SESSION_NAME=${SESSION_NAME//./_}
shift

in_tmux_exec() {
  NEW_WINDOW_AND_PANE=$(
    tmux new-window -P -d -t "$SESSION_NAME" -n "$COMMAND_BIN" "$@"
  )
  tmux select-pane -t "${NEW_WINDOW_AND_PANE}"
}

set -x
if ! tmux has-session -t "$SESSION_NAME"; then
  # if we don't already have a session start one
  TMUX_SESSIONATOR=~/.tmux/plugins/tmux-sessionator/scripts/load-layout.sh
  if [ -f "$TMUX_SESSIONATOR" ]; then
    exec tmux new-session -s 0 "$TMUX_SESSIONATOR" "$SESSION_NAME"
  else
    exec tmux new-session -d -s "$SESSION_NAME"
  fi
fi

if [ $# -ge 1 ]; then
  COMMAND_BIN=$(basename "${1%% *}")
  # execute command in new window if given a command after session name
  in_tmux_exec "$@"
else
  # or otherwise attach to the session
  exec tmux attach-session -t "$SESSION_NAME"
fi
